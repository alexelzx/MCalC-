<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartST | Mode Focus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #02040a;
            --surface: rgba(255,255,255,0.03);
            --border: 1px solid rgba(255,255,255,0.08);
            --cyan: #22d3ee;
            --green: #10b981;
            --red: #f43f5e;
            --gold: #fbbf24;
            --text-main: #f8fafc;
            --text-mute: #94a3b8;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin:0; font-family:'Outfit', sans-serif; background: radial-gradient(circle at 50% -20%, #0f172a 0%, #02040a 80%); color:var(--text-main); height:100vh; overflow:hidden; display:flex; flex-direction:column; }
        
        /* LAYOUT */
        .screen { display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; width:100%; padding:30px; opacity:0; transition: opacity 0.4s ease; }
        .screen.active { display:flex; opacity:1; }

        /* COMPONENTS */
        .glass-panel { background:var(--surface); border:var(--border); border-radius:24px; padding:40px 30px; width:100%; max-width:420px; text-align:center; backdrop-filter:blur(20px); }
        
        h1 { font-size:1.8rem; font-weight:700; margin:0 0 10px 0; letter-spacing:-0.5px; color:white; }
        h2 { font-size:0.8rem; text-transform:uppercase; letter-spacing:3px; color:var(--text-mute); margin-bottom:30px; font-weight:500; }
        p { color:var(--text-mute); font-size:0.95rem; line-height:1.6; margin-bottom:30px; }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(34, 211, 238, 0.05));
            border: 1px solid rgba(34, 211, 238, 0.3); color: var(--cyan);
            font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
            padding: 16px 32px; border-radius: 50px; cursor: pointer; width: 100%;
            font-size: 0.85rem; transition: 0.3s; display:flex; align-items:center; justify-content:center; gap:10px;
        }
        .btn:hover { background: rgba(34, 211, 238, 0.2); box-shadow: 0 0 30px rgba(34, 211, 238, 0.15); }
        .btn-secondary { background: transparent; border: var(--border); color: var(--text-mute); }
        .btn-secondary:hover { border-color:white; color:white; background:rgba(255,255,255,0.05); box-shadow:none; }

        /* INPUTS */
        #taskList { width:100%; max-height:220px; overflow-y:auto; margin:20px 0; padding-right:5px; }
        .task-row { display:flex; gap:10px; margin-bottom:10px; }
        .input-field { background:rgba(0,0,0,0.3); border:var(--border); color:white; padding:12px 15px; border-radius:12px; font-family:'Outfit', sans-serif; font-size:0.9rem; transition:0.3s; }
        .input-field:focus { border-color:var(--cyan); }
        .t-name { flex:1; }
        .t-time { width:70px; text-align:center; }

        /* TIMER VISUALS */
        .timer-container { position:relative; width:260px; height:260px; display:flex; justify-content:center; align-items:center; margin:40px 0; }
        .timer-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .timer-active-ring {
            position: absolute; inset: -2px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: var(--cyan); border-right-color: var(--cyan);
            animation: spin 3s linear infinite; opacity:0; transition: opacity 0.5s;
        }
        .timer-container.running .timer-active-ring { opacity: 1; }
        
        .time-val { font-size:4.5rem; font-weight:200; letter-spacing:-2px; z-index:2; font-variant-numeric: tabular-nums; }
        .task-label { font-size:0.75rem; color:var(--cyan); text-transform:uppercase; letter-spacing:2px; margin-top:10px; font-weight:700; }

        /* LOGS */
        .log-item { display:flex; justify-content:space-between; padding:12px 0; border-bottom:var(--border); font-size:0.9rem; }
        .log-status { font-weight:700; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; }
        .status-green { color:var(--green); }
        .status-red { color:var(--red); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-onboard" class="screen active">
        <div class="glass-panel">
            <h1>Session Focus</h1>
            <h2>Protocole de Productivité</h2>
            <p>Définissez vos tâches. Estimez la durée. Exécutez sans distraction.</p>
            <div style="text-align:left; background:rgba(255,255,255,0.02); padding:20px; border-radius:16px; border:var(--border); margin-bottom:30px;">
                <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                    <div style="width:6px; height:6px; background:var(--cyan); border-radius:50%;"></div>
                    <span style="font-size:0.9rem; color:#ccc;">Suivi de Performance</span>
                </div>
                <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                    <div style="width:6px; height:6px; background:var(--cyan); border-radius:50%;"></div>
                    <span style="font-size:0.9rem; color:#ccc;">Analyse Gestion du Temps</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="width:6px; height:6px; background:var(--gold); border-radius:50%;"></div>
                    <span style="font-size:0.9rem; color:#ccc;">Gain XP (+50 XP/Tâche)</span>
                </div>
            </div>
            <button class="btn" onclick="nextScreen('setup')">INITIALISER</button>
        </div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="glass-panel" style="max-width:500px;">
            <h1>Plan de Session</h1>
            <h2>Définir les Objectifs</h2>
            
            <div id="taskList">
                <div class="task-row">
                    <input type="text" class="input-field t-name" placeholder="Nom de la tâche (ex: Révision)">
                    <input type="number" class="input-field t-time" placeholder="Min" value="25">
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="addTaskRow()" style="margin-bottom:20px; font-size:0.75rem;">+ AJOUTER UN OBJECTIF</button>
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-top:var(--border); padding-top:20px; margin-bottom:30px;">
                <span style="color:var(--text-mute); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Estimation Totale</span>
                <span id="totalTimeDisplay" style="color:white; font-weight:700; font-size:1.2rem;">25 min</span>
            </div>
            <button class="btn" onclick="startSession()">LANCER LA SESSION</button>
        </div>
    </div>

    <div id="screen-active" class="screen">
        <div class="task-label" id="activeTaskName">SÉQUENCE 1/1</div>
        <div class="timer-container" id="timerRing">
            <div class="timer-ring"></div>
            <div class="timer-active-ring"></div>
            <div class="time-val" id="timerDisplay">00:00</div>
        </div>
        
        <div class="glass-panel" style="padding:25px; border-color:var(--cyan);">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:var(--text-mute); font-size:0.7rem; letter-spacing:1px; text-transform:uppercase;">Objectif en Cours</span>
                <span style="color:var(--cyan); font-weight:700; font-size:0.7rem; letter-spacing:1px;" id="taskTimer">CIBLE : 25 MIN</span>
            </div>
            <h3 id="currentTaskTitle" style="margin:0 0 25px 0; color:white; font-size:1.2rem; font-weight:500;">...</h3>
            <button class="btn" onclick="completeTask()" style="border-color:var(--green); color:var(--green); background:rgba(16, 185, 129, 0.1);">
                MARQUER COMME TERMINÉ
            </button>
        </div>
    </div>

    <div id="screen-summary" class="screen">
        <div class="glass-panel">
            <h1 style="color:var(--gold);">RAPPORT DE SESSION</h1>
            <div style="font-size:3.5rem; font-weight:800; color:white; margin:10px 0;" id="finalScore">+0 XP</div>
            <p style="margin-bottom:30px;">Analyse de Performance</p>
            
            <div id="summaryList" style="text-align:left; margin-bottom:30px; border-top:var(--border);"></div>
            
            <button class="btn" onclick="window.location.href='pom-leaderboard.html'">VOIR LE CLASSEMENT</button>
            <button class="btn btn-secondary" onclick="window.location.href='smartst-cloud-access.html'" style="margin-top:15px;">RETOUR TABLEAU DE BORD</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAR7j3DDQQWHIEwv1_-PHQsSHze3kphPk8",
            authDomain: "smartst-os.firebaseapp.com",
            projectId: "smartst-os",
            storageBucket: "smartst-os.firebasestorage.app",
            messagingSenderId: "866980185011",
            appId: "1:866980185011:web:03006fe6a81634d5dec1c6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let tasks = [];
        let currentTaskIndex = 0;
        let sessionTimeLeft = 0;
        let taskStartTime = 0;
        let globalTimer = null;
        let totalXP = 0;
        let sessionLog = [];

        onAuthStateChanged(auth, (user) => {
            if(user) currentUser = user;
            else window.location.href = 'index.html';
        });

        window.nextScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${id}`).classList.add('active');
        }

        window.addTaskRow = () => {
            const div = document.createElement('div');
            div.className = 'task-row';
            div.innerHTML = `<input type="text" class="input-field t-name" placeholder="Nom Tâche"><input type="number" class="input-field t-time" placeholder="Min" value="15">`;
            document.getElementById('taskList').appendChild(div);
            updateTotalEst();
        }

        document.getElementById('taskList').addEventListener('input', updateTotalEst);

        function updateTotalEst() {
            let total = 0;
            document.querySelectorAll('.t-time').forEach(i => total += parseInt(i.value || 0));
            document.getElementById('totalTimeDisplay').innerText = total + " min";
        }

        window.startSession = () => {
            tasks = [];
            document.querySelectorAll('.task-row').forEach(r => {
                const name = r.querySelector('.t-name').value;
                const min = parseInt(r.querySelector('.t-time').value);
                if(name && min) tasks.push({ name, estSeconds: min * 60 });
            });

            if(tasks.length === 0) return alert("La liste des tâches ne peut pas être vide.");

            sessionTimeLeft = tasks.reduce((acc, t) => acc + t.estSeconds, 0);
            currentTaskIndex = 0;
            totalXP = 0;
            sessionLog = [];
            
            nextScreen('active');
            document.getElementById('timerRing').classList.add('running');
            startGlobalTimer();
            startTask(0);
        }

        function startGlobalTimer() {
            globalTimer = setInterval(() => {
                sessionTimeLeft--;
                const m = Math.floor(sessionTimeLeft / 60).toString().padStart(2,'0');
                const s = (sessionTimeLeft % 60).toString().padStart(2,'0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
                if(sessionTimeLeft <= 0) endSession();
            }, 1000);
        }

        function startTask(index) {
            if(index >= tasks.length) { endSession(); return; }
            const task = tasks[index];
            document.getElementById('activeTaskName').innerText = `SÉQUENCE ${index + 1}/${tasks.length}`;
            document.getElementById('currentTaskTitle').innerText = task.name;
            document.getElementById('taskTimer').innerText = `CIBLE : ${Math.floor(task.estSeconds/60)} MIN`;
            taskStartTime = Date.now();
        }

        window.completeTask = () => {
            const task = tasks[currentTaskIndex];
            const timeTaken = (Date.now() - taskStartTime) / 1000;
            
            let xpEarned = 0;
            let status = "DÉPASSEMENT";
            
            if (timeTaken <= task.estSeconds) {
                xpEarned = 50;
                status = "EN AVANCE";
            }

            totalXP += xpEarned;
            sessionLog.push({ name: task.name, xp: xpEarned, status });
            currentTaskIndex++;
            startTask(currentTaskIndex);
        }

        async function endSession() {
            clearInterval(globalTimer);
            document.getElementById('timerRing').classList.remove('running');
            nextScreen('summary');
            document.getElementById('finalScore').innerText = "+" + totalXP + " XP";
            
            const list = document.getElementById('summaryList');
            list.innerHTML = '';
            sessionLog.forEach(l => {
                const col = l.xp > 0 ? 'status-green' : 'status-red';
                const xpTxt = l.xp > 0 ? `+${l.xp} XP` : '0 XP';
                list.innerHTML += `
                    <div class="log-item">
                        <span>${l.name}</span>
                        <div style="text-align:right;">
                            <div class="log-status ${col}">${l.status}</div>
                            <div style="font-size:0.7rem; color:#666;">${xpTxt}</div>
                        </div>
                    </div>`;
            });

            if(currentUser && totalXP > 0) {
                const userRef = doc(db, "students", currentUser.uid);
                updateDoc(userRef, { pomodoro_xp: increment(totalXP), xp: increment(totalXP) }).catch(console.error);
            }
        }
    </script>
</body>
</html>
